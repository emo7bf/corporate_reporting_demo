# ============================================
# Dummy Inputs for Responsible Sourcing Prototype
# ============================================

original_text_2023 = """Responsible Sourcing

Supply Chain Management
KLA aims to ensure reliable, efficient access to the goods and services needed to create our products. We evaluate our suppliers and require compliance with business codes of conduct, human rights standards, and the terms and conditions in our contracts that directly support responsible sourcing. Through ongoing engagement and innovation, we build stronger supplier relationships, optimize our supply chain and strengthen KLA’s competitive advantage.

“At KLA, we understand the profound impact our technology has on shaping the future. By constantly innovating and partnering responsibly, we’re committed to driving progress and transforming industries.”
— Theo Kneepkens, Senior Vice President, Global Operations

KLA’s Supply Chain Management (SCM) program works toward continuous improvement throughout the KLA product lifecycle and supplier relationship, communicating our expectations and providing guidance to our suppliers. For supplier managers, category managers and buyers, our cross-functional selection and qualification process includes guidance on required deliverables, supplier engagement and performance improvement for direct suppliers. A similar process called Source to Manage provides guidance regarding new and existing indirect suppliers.

Through our supplier tiering process, we create required scorecard reviews that track changes in a supplier’s overall performance across both business metrics and ESG issues, including financial, country-specific, and commodity-specific risks. As part of the SCM process, suppliers undergo planned business reviews, site visits and RBA SAQ facility risk assessments, as appropriate.

KLA expects suppliers to review, understand and act in accordance with our Supplier Standards of Business Conduct as well as our Global Human Rights Standard, which is aligned with the RBA Code of Conduct. Together, these standards cover areas including labor rights, safe and healthy work environments for employees, adherence to applicable environmental and employment laws, responsible handling of certain metals and minerals, and ethical business practices.

KLA is a regular member of the RBA, and each year we assess key direct suppliers using the RBA Self-Assessment Questionnaire (SAQ), which provides KLA and the supplier with an overall risk score for individual supplier facilities. We monitor the results of those assessments, comparing with previous years to gauge the supplier’s overall risk level, identify areas for improvement and track those areas until they are fully addressed. Suppliers that post an overall high-risk score are subject to a third-party audit (per RBA member guidance) to gain a deeper view into their risk issues, and we work with them to improve their score. In 2023, we achieved an 85% response rate for direct suppliers asked to complete the RBA facilities self-assessment.

In 2023, as part of our continuous improvement efforts, we increased the number of direct suppliers surveyed by 29%. We also successfully expanded the program to include our top tier 1 indirect suppliers. This new effort resulted in an 87% completion rate of the Indirect Facility SAQs requested.

For the first time, we rolled out a separate initiative in 2023 to engage key KLA suppliers around disclosing metrics to CDP and working toward establishing climate goals covering their emissions. We targeted suppliers that represent the highest impact emissions for our purchased goods and services and saw a higher-than-expected initial response rate. See the Reducing Supply Chain Carbon Impacts section of this report for more details on this initiative.

Human Rights
KLA believes individuals have the right to work in an environment that upholds labor rights, forbids harassment and discrimination, and is free from all forms of forced labor. We recognize the potential human rights issues and labor risks that may occur in our supply chain, especially for vulnerable populations including women, children and minority groups. Through our Global Human Rights Standards, we communicate the company’s high expectations to our supply chain partners, and our global supply chain management program supports efforts to drive ongoing compliance and transparency regarding human rights throughout our supply chain. We enforce our human rights policies through our annual RBA Supplier Assessment Questionnaire (SAQ), contractual supplier requirements and ongoing supplier relationship management.

Managing Conflict Minerals
KLA strives for responsible sourcing of minerals used by suppliers in the creation of our products. As part of this effort, we aim to take reasonable steps to validate that our products contain no tantalum, tin, tungsten or gold (3TG or “conflict minerals”) sourced from the Democratic Republic of Congo and adjoining countries where their production is known to fund conflict or human rights abuses. In alignment with U.S. regulations, we complete an annual Reasonable Country of Origin Inquiry (RCOI) into 3TG minerals in our supply chain. Following verification by a third party, we use the results of this inquiry to inform mitigation strategies, supplier engagement priorities and annual disclosures. In 2023, we began expanding our inquiry to include cobalt and mica, two emerging materials of concern. For details, see our Product Regulatory Compliance Guidelines for KLA Suppliers.

Supplier Inclusion and Diversity
KLA strives to build an inclusive supply chain, and we recognize that partnering with a broad range of suppliers is fundamental to the company’s continued success. In our sourcing and purchasing activities, we seek out a variety of suppliers whose goods and services meet KLA’s standards, supplier selection criteria and customer requirements. The Supplier Inclusion & Diversity page of our website encourages potential new certified suppliers to notify KLA if they meet any of the recognized categories listed in our Supplier Diversity Classifications Guide. We maintain memberships with organizations that focus on the growth of our supplier base. In 2023, we gave supplier managers access to a third-party database to search for potential diverse suppliers that may meet KLA's needs and stringent standards. We also continued our engagement with the Western Regional Minority Supplier Development Council (WRMSDC) and the SEMI Manufacturing Ownership Diversity (MOD) working group. As a recognized Bronze-level corporate member of the WRMSDC, KLA shares best practices aimed at building more inclusive supply chains. We also support WRMSDC’s mission to expand business education and develop business development scholarships. Through SEMI-MOD, we participate in efforts focusing on the capabilities of suppliers in the semiconductor manufacturing industry.

Keep Looking Ahead
Next Steps in 2024 and Beyond
• Launch a Sustainability Roundtable (SRT): In 2024, we will launch a cross-divisional working group of engineering representatives to share best-known methods and use cases companywide, with an initial focus on product efficiency. The SRT will meet regularly and report to the Product ESG Steering Team.
• Work collaboratively on Legal, ESG and Geopolitical (LEGO) developments: In 2024, we plan to formalize KLA’s LEGO taskforce, launch a supplier survey on iron and steel imported into the EU, and expand the per- and polyfluoroalkyl substances (PFAS) survey initiated in 2023 across the broader supply chain.
• Measure supplier business continuity planning: KLA’s purchase agreement requires our direct supply chain partners to have business continuity plans in place. In 2024, we aim to launch a supplier risk management survey to assess suppliers’ maturity in the areas of resiliency, cybersecurity, intellectual property protection and responsible sourcing."""


outputted_text_2024 = """Responsible Sourcing
KLA aims to secure reliable, efficient access to the goods and services we need to develop our products. We evaluate our suppliers and require compliance with our Standards of Business Conduct for Suppliers, Global Human Rights Standards, and the terms and conditions in our contracts that directly support responsible sourcing. Through ongoing engagement, innovation and supply chain optimization, we work to build stronger relationships with our suppliers and strengthen KLA’s competitive advantage.

“As an industrial engineer, I love working on the edge of technology, striving to meet dynamic market demands. It’s gratifying to solve technical challenges, balance supply and demand, and optimize processes and systems. I also take pride in our commitment to responsible sourcing, striving to obtain materials and components in an ethical and sustainable manner.”
— Sharon Yogev, vice president, operations

Supply Chain Management
KLA’s supply chain management (SCM) program works toward continuous improvement throughout the KLA product lifecycle and supplier relationship, communicating our expectations and providing guidance to our suppliers. For supplier managers, category managers and buyers, our cross-functional selection and qualification process includes guidance on required deliverables, supplier engagement and performance improvement for direct suppliers. Similarly, our Sourcing Guidelines provide guidance regarding new and existing indirect suppliers.

Through our tiering process for direct suppliers, we create required scorecard reviews that track changes in a supplier’s overall performance across both business metrics and ESG issues, including country-specific risks, commodity-specific risks, and financial, environmental and social responsibility programs. As part of the SCM process, suppliers undergo planned business reviews, site visits and RBA risk assessments, as appropriate.

KLA is a regular member of the Responsible Business Alliance and uses the RBA Self-Assessment Questionnaire (SAQ) to assess suppliers’ inherent risks, assess controls designed to mitigate potential risks (with an option to have the RBA validate those controls) and create an overall risk score for individual supplier facilities. We monitor the results of those assessments, comparing with previous years to gauge the supplier’s overall risk level, identify areas for improvement and track those areas until they are fully addressed. Suppliers that post an overall high-risk score are subject to a third-party audit (per RBA member guidance) to gain a deeper view into their risk issues. Once these are identified, we work with the supplier through the RBA corrective action plan process to improve their score.

In 2024, we transitioned all direct suppliers to the RBA’s facility-level risk SAQ. Additionally, we expect suppliers participating in the facility risk SAQ and indirect SAQ processes to review and accept KLA’s Standards of Business Conduct for Suppliers. KLA expects suppliers to also review, understand and act in accordance with our Global Human Rights Standards, which is aligned with the RBA Code of Conduct. Together, these standards cover areas including labor rights, safe and healthy work environments for employees, adherence to applicable environmental and employment laws, responsible sourcing of minerals, and ethical business practices.

For 2024, we achieved a 94% response rate for direct suppliers asked to complete the RBA facility risk SAQ. As part of the 2024 indirect spend SAQ, we achieved an 85% response rate for indirect suppliers. Additionally, we encourage our key suppliers to disclose their emissions metrics to CDP and work toward establishing reduction goals. In 2024, we received disclosure responses from 72% of suppliers contacted, outperforming the average CDP response rate for North America supply chain members. See the Reducing Supply Chain Carbon Impacts section of this report for more details on this initiative.

To help our suppliers build ESG capacity and improve performance, we provided them with a webinar in 2024 on conflict minerals and product compliance for REACH, RoHS, PFAS and POP, and updated our Supplier Support Guide for Compliance Programs. We also launched a Supplier Risk Management Survey to gain insight into supplier maturity in the areas of resiliency, cybersecurity, intellectual property protection and responsible sourcing. Insights from respondents are being reviewed and prioritized to inform potential improvement opportunities.

In 2024, we launched a Legislative, ESG and Geopolitical (LEGO) forum. This program aims to enhance KLA's ability to navigate and mitigate risks associated with LEGO factors that pose significant threats to the supply chain, including but not limited to human rights, chemical substances, and minerals, metals and related materials, especially where such factors intersect with higher-risk countries. During the year, LEGO made preparations for the required 2025–26 reporting on perfluoroalkyl and polyfluoroalkyl substances (PFAS) mandated by the TSCA, and identified and documented other compliance/ESG efforts and initiatives. In 2024, we continued a supplier survey to identify PFAS within our products, and investigated iron and steel imported into the European Union (EU). We continue to review the information captured in the supplier survey.

Human Rights
KLA believes individuals have the right to work in an environment that upholds labor standards, forbids harassment and discrimination, and is free from all forms of forced labor. We remain vigilant for any potential human rights issues and labor risks that may occur in our supply chain, especially in regard to vulnerable populations including women, children and minority groups. Through KLA’s Global Human Rights Standards, we communicate the company’s high expectations to supply chain partners, and our global supply chain management program supports efforts to drive ongoing compliance and transparency regarding human rights throughout the supply chain. Annually, KLA assesses the risk of forced labor in our supply chain by leveraging the RBA SAQ process. The SAQ addresses topics such as recruitment practices, employment contracts, freedom of movement, retention of personal documents, and working conditions to help identify risks related to forced labor. KLA enforces our human rights policies through contractual supplier requirements and ongoing supplier relationship management. We also provide internal training on preventing human trafficking and slavery to select KLA employees based on their job function. Our supply chain partners are encouraged to ask questions, seek guidance, report suspected violations and express any concerns about human rights issues confidentially via KLA’s Compliance Hotline, Ethics Point, including anonymously if they so choose.

Minerals Sourcing
KLA strives for responsible sourcing of minerals used by suppliers in the development and manufacture of our products. As part of this effort, we aim to take reasonable steps to validate that our products contain no tantalum, tin, tungsten or gold (3TG or “conflict minerals”) sourced from the Democratic Republic of Congo and adjoining countries, where their production has been known to fund conflict and human rights abuses. In alignment with U.S. regulations, we complete an annual Reasonable Country of Origin Inquiry (RCOI) into 3TG minerals in our supply chain. Following verification by a third party, we use the results of this inquiry to inform mitigation strategies, supplier engagement priorities and annual disclosures. In 2024, we also implemented use of the Responsible Minerals Initiative’s Extended Minerals Reporting Template (EMRT), which organizes the collection and disclosure of information about the presence of cobalt and mica in the company’s supply chain, helping mitigate risks and ensure responsible sourcing. For more details, see our Product Regulatory Compliance Guidelines for KLA Suppliers.

Keep Looking Ahead: Responsible Sourcing
• Engaging our supply chain: To continue prioritizing customer needs and requirements, KLA will work to ensure continued supply chain resilience and engage supply chain partners around compliance with company policies and applicable standards, laws and regulations.
• Expanding our supply chain: KLA will continue our commitment to expanding the breadth of our supply chain by engaging in broad sourcing strategies and encouraging small businesses to respond to solicitations. We will always select the best company to meet our requirements while ensuring equal opportunity and nondiscrimination in our processes.
• Growing industry leadership: KLA will assume the lead role in the Best Practices Working Group within the SEMI Global Supplier Opportunity Network (GSON)."""


# 1) Mock, imperative team inputs (what humans type this year)
user_input_updates = [
    {
        "id": "u1",
        "change_type": "modification",
        "request": "Swap out Theo's quote for Sharon — update the voice and the role/title.",
        "section_hint": "Responsible Sourcing > opening quote"
    },
    {
        "id": "u2",
        "change_type": "modification",
        "request": "Change 'Source to Manage' to 'Sourcing Guidelines' for indirect suppliers.",
        "section_hint": "Responsible Sourcing > SCM process"
    },
    {
        "id": "u3",
        "change_type": "modification",
        "request": "Expand risk language — include environmental and social responsibility programs explicitly.",
        "section_hint": "Responsible Sourcing > tiering/scorecards"
    },
    {
        "id": "u4",
        "change_type": "modification",
        "request": "Strengthen SAQ text: compare YoY, audit high-risk via third parties, and track corrective actions.",
        "section_hint": "Responsible Sourcing > RBA/SAQ"
    },
    {
        "id": "u5",
        "change_type": "modification",
        "request": "Update metrics to 94% direct SAQ, 85% indirect SAQ, and 72% CDP disclosure.",
        "section_hint": "Responsible Sourcing > metrics"
    },
    {
        "id": "u6",
        "change_type": "addition",
        "request": "Add supplier webinar line (conflict minerals, REACH, RoHS, PFAS, POP) + Supplier Risk Management Survey.",
        "section_hint": "Responsible Sourcing > supplier enablement"
    },
    {
        "id": "u7",
        "change_type": "addition",
        "request": "Convert LEGO taskforce plan to a live forum; note PFAS prep (TSCA), EU iron/steel, ongoing supplier survey.",
        "section_hint": "Responsible Sourcing > LEGO"
    },
    {
        "id": "u8",
        "change_type": "addition",
        "request": "Add a Supplier Sustainability Award recognition line.",
        "section_hint": "Responsible Sourcing > recognition"
    },
    {
        "id": "u9",
        "change_type": "modification",
        "request": "Update minerals paragraph to include EMRT for cobalt and mica.",
        "section_hint": "Responsible Sourcing > minerals"
    }
]

# 2) Tiny dummy “RAG corpus” for standards
standards_index = {
    "ISS:A.1.0.1.2": {
        "source": "ISS (ESG)",
        "title": "Supplier Code of Conduct & Human Rights Alignment",
        "clause": "Issuer should require supplier adherence to a codified Supplier Code aligned with international human rights norms and industry codes (e.g., RBA)."
    },
    "RBA:L.2.3": {
        "source": "Responsible Business Alliance",
        "title": "Facility-Level Risk Assessment & Corrective Action",
        "clause": "Use facility-level SAQs, audit high-risk sites, and track corrective actions to closure."
    },
    "CDP:B.2.1": {
        "source": "CDP Supply Chain",
        "title": "Supplier Climate Disclosure & Target Setting",
        "clause": "Encourage supplier emissions disclosure and progress toward science-based targets; report response rates YoY."
    },
    "RMI:EMRT:C.4.2": {
        "source": "Responsible Minerals Initiative",
        "title": "Extended Minerals Reporting Template (EMRT)",
        "clause": "Collect cobalt and mica data via EMRT to increase transparency and mitigate material sourcing risks."
    },
    "PRC:D.5.1": {
        "source": "Product Regulatory Compliance",
        "title": "Supplier Compliance Enablement (REACH/RoHS/PFAS/POP)",
        "clause": "Provide supplier education and documentation on REACH, RoHS, PFAS, and POP."
    },
    "TSCA:PFAS:E.7.9": {
        "source": "US EPA / TSCA",
        "title": "PFAS Readiness & Data Collection",
        "clause": "Prepare supplier disclosures to meet PFAS reporting obligations; implement surveys and data governance."
    },
    "SRM:F.1.1": {
        "source": "Supplier Risk Management Practice",
        "title": "Supplier Risk Management Survey",
        "clause": "Assess resiliency, cybersecurity, IP protection, and responsible sourcing maturity."
    },
    "REC:G.2.0": {
        "source": "Supplier Recognition Best Practice",
        "title": "ESG Recognition Programs",
        "clause": "Acknowledge suppliers demonstrating strong ESG performance through formal recognition."
    }
}

####################################

# 3) RAG-informed, rephrased updates WITH hover-highlight snippets
transformed_updates = [
    {
        "id": "u1",
        "raw_request": "Swap out Theo's quote for Sharon — update the voice and the role/title.",
        "change_type": "modification",
        "standard_refs": ["ISS:A.1.0.1.2"],
        "rag_snippets": [standards_index["ISS:A.1.0.1.2"]["clause"]],
        "rephrased_update": (
            "Replace the leadership quote to reflect current operations leadership and reaffirm adherence to KLA’s "
            "Standards of Business Conduct for Suppliers and Global Human Rights Standards, aligned with RBA."
        ),
        "target_section_hint": "opening/quote",
        "original_text_to_highlight": (
            "“At KLA, we understand the profound impact our technology has on shaping the future. By constantly innovating and partnering responsibly, "
            "we’re committed to driving progress and transforming industries.”"
        ),
        "new_text_to_highlight": (
            "“As an industrial engineer, I love working on the edge of technology, striving to meet dynamic market demands. "
            "It’s gratifying to solve technical challenges, balance supply and demand, and optimize processes and systems. "
            "I also take pride in our commitment to responsible sourcing, striving to obtain materials and components in an ethical and sustainable manner.”"
        ),
    },
    {
        "id": "u2",
        "raw_request": "Change 'Source to Manage' to 'Sourcing Guidelines' for indirect suppliers.",
        "change_type": "modification",
        "standard_refs": ["ISS:A.1.0.1.2"],
        "rag_snippets": [standards_index["ISS:A.1.0.1.2"]["clause"]],
        "rephrased_update": (
            "Update indirect supplier process terminology to “Sourcing Guidelines” and explicitly reference conformity "
            "with the Supplier Code and Human Rights Standards."
        ),
        "target_section_hint": "SCM process paragraph",
        "original_text_to_highlight": (
            "A similar process called Source to Manage provides guidance regarding new and existing indirect suppliers."
        ),
        "new_text_to_highlight": (
            "Similarly, our Sourcing Guidelines provide guidance regarding new and existing indirect suppliers."
        ),
    },
    {
        "id": "u3",
        "raw_request": "Expand risk language — include environmental and social responsibility programs explicitly.",
        "change_type": "modification",
        "standard_refs": ["ISS:A.1.0.1.2"],
        "rag_snippets": [standards_index["ISS:A.1.0.1.2"]["clause"]],
        "rephrased_update": (
            "Broaden supplier scorecard factors to clearly include environmental and social responsibility programs, "
            "in addition to country-, commodity-, and financial risks."
        ),
        "target_section_hint": "tiering/scorecards",
        "original_text_to_highlight": "including financial, country-specific, and commodity-specific risks.",
        "new_text_to_highlight": (
            "including country-specific risks, commodity-specific risks, and financial, environmental and social responsibility programs."
        ),
    },
    {
        "id": "u4",
        "raw_request": "Strengthen SAQ text: compare YoY, audit high-risk via third parties, and track corrective actions.",
        "change_type": "modification",
        "standard_refs": ["RBA:L.2.3"],
        "rag_snippets": [standards_index["RBA:L.2.3"]["clause"]],
        "rephrased_update": (
            "State that facility-level SAQs are compared year-over-year, high-risk facilities undergo third-party audits, "
            "and findings are remediated through corrective action plans tracked to closure."
        ),
        "target_section_hint": "RBA/SAQ paragraph",
        "original_text_to_highlight": (
            "Suppliers that post an overall high-risk score are subject to a third-party audit (per RBA member guidance) "
            "to gain a deeper view into their risk issues, and we work with them to improve their score."
        ),
        "new_text_to_highlight": (
            "Suppliers that post an overall high-risk score are subject to a third-party audit (per RBA member guidance) to gain a deeper view into their risk issues. "
            "Once these are identified, we work with the supplier through the RBA corrective action plan process to improve their score."
        ),
    },
    {
        "id": "u5",
        "raw_request": "Update metrics to 94% direct SAQ, 85% indirect SAQ, and 72% CDP disclosure.",
        "change_type": "modification",
        "standard_refs": ["CDP:B.2.1"],
        "rag_snippets": [standards_index["CDP:B.2.1"]["clause"]],
        "rephrased_update": (
            "Report 94% direct supplier SAQ completion, 85% indirect supplier SAQ completion, and 72% supplier climate "
            "disclosure to CDP, highlighting year-over-year improvement."
        ),
        "target_section_hint": "metrics paragraph",
        "original_text_to_highlight": (
            "In 2023, we achieved an 85% response rate for direct suppliers asked to complete the RBA facilities self-assessment."
        ),
        "new_text_to_highlight": (
            "For 2024, we achieved a 94% response rate for direct suppliers asked to complete the RBA facility risk SAQ. "
            "As part of the 2024 indirect spend SAQ, we achieved an 85% response rate for indirect suppliers."
        ),
    },
    {
        "id": "u6",
        "raw_request": "Add supplier webinar line (conflict minerals, REACH, RoHS, PFAS, POP) + Supplier Risk Management Survey.",
        "change_type": "addition",
        "standard_refs": ["PRC:D.5.1", "SRM:F.1.1"],
        "rag_snippets": [
            standards_index["PRC:D.5.1"]["clause"],
            standards_index["SRM:F.1.1"]["clause"]
        ],
        "rephrased_update": (
            "Add supplier enablement language noting a webinar series on conflict minerals and regulatory compliance "
            "(REACH, RoHS, PFAS, POP) and the launch of a Supplier Risk Management Survey covering resiliency, "
            "cybersecurity, IP protection, and responsible sourcing."
        ),
        "target_section_hint": "supplier enablement",
        "original_text_to_highlight": "",
        "new_text_to_highlight": (
            "To help our suppliers build ESG capacity and improve performance, we provided them with a webinar in 2024 on conflict minerals and product compliance for REACH, RoHS, PFAS and POP, "
            "and updated our Supplier Support Guide for Compliance Programs. We also launched a Supplier Risk Management Survey to gain insight into supplier maturity in the areas of resiliency, "
            "cybersecurity, intellectual property protection and responsible sourcing."
        ),
    },
    {
        "id": "u7",
        "raw_request": "Convert LEGO taskforce plan to a live forum; note PFAS prep (TSCA), EU iron/steel, ongoing supplier survey.",
        "change_type": "addition",
        "standard_refs": ["TSCA:PFAS:E.7.9"],
        "rag_snippets": [standards_index["TSCA:PFAS:E.7.9"]["clause"]],
        "rephrased_update": (
            "Note the launch of the LEGO forum to coordinate legal/ESG/geopolitical risk readiness, including PFAS "
            "preparedness under TSCA and review of EU iron/steel supplier disclosures, supported by ongoing supplier surveys."
        ),
        "target_section_hint": "LEGO forum",
        "original_text_to_highlight": (
            "• Work collaboratively on Legal, ESG and Geopolitical (LEGO) developments: In 2024, we plan to formalize KLA’s LEGO taskforce, "
            "launch a supplier survey on iron and steel imported into the EU, and expand the per- and polyfluoroalkyl substances (PFAS) survey initiated in 2023 across the broader supply chain."
        ),
        "new_text_to_highlight": (
            "In 2024, we launched a Legislative, ESG and Geopolitical (LEGO) forum. "
            "This program aims to enhance KLA's ability to navigate and mitigate risks associated with LEGO factors that pose significant threats to the supply chain, including but not limited to human rights, "
            "chemical substances, and minerals, metals and related materials, especially where such factors intersect with higher-risk countries. "
            "During the year, LEGO made preparations for the required 2025–26 reporting on perfluoroalkyl and polyfluoroalkyl substances (PFAS) mandated by the TSCA, and identified and documented other compliance/ESG efforts and initiatives."
        ),
    },
    {
        "id": "u8",
        "raw_request": "Add a Supplier Sustainability Award recognition line.",
        "change_type": "addition",
        "standard_refs": ["REC:G.2.0"],
        "rag_snippets": [standards_index["REC:G.2.0"]["clause"]],
        "rephrased_update": (
            "Introduce a Supplier Sustainability Award recognizing suppliers with leading environmental, social, and "
            "economic impact management and transparent reporting."
        ),
        "target_section_hint": "recognition",
        "original_text_to_highlight": "",
        "new_text_to_highlight": ""  # not present in provided 2024 text (to-be-inserted change)
    },
    {
        "id": "u9",
        "raw_request": "Update minerals paragraph to include EMRT for cobalt and mica.",
        "change_type": "modification",
        "standard_refs": ["RMI:EMRT:C.4.2"],
        "rag_snippets": [standards_index["RMI:EMRT:C.4.2"]["clause"]],
        "rephrased_update": (
            "Add that KLA uses the Responsible Minerals Initiative’s Extended Minerals Reporting Template (EMRT) "
            "to organize cobalt and mica due diligence and disclosures."
        ),
        "target_section_hint": "minerals sourcing",
        "original_text_to_highlight": (
            "In 2023, we began expanding our inquiry to include cobalt and mica, two emerging materials of concern."
        ),
        "new_text_to_highlight": (
            "In 2024, we also implemented use of the Responsible Minerals Initiative’s Extended Minerals Reporting Template (EMRT), "
            "which organizes the collection and disclosure of information about the presence of cobalt and mica in the company’s supply chain, "
            "helping mitigate risks and ensure responsible sourcing."
        ),
    }
]


#######################################################

import streamlit as st
import html
import json
from difflib import ndiff

# ---- Assume these are already imported/defined in your environment ----
# original_text_2023
# outputted_text_2024
# user_input_updates
# standards_index
# transformed_updates

# --------- Styling ---------
st.set_page_config(page_title="Responsible Sourcing – Update Reviewer", layout="wide")
CUSTOM_CSS = f"""
<style>
/* Background + general text */
body, .stApp {{
  background-color: #FFFFFF;
  color: #333333;
  font-family: "Segoe UI", "Helvetica Neue", sans-serif;
}}

/* Headers */
h1, h2, h3, .stMarkdown h1, .stMarkdown h2 {{
  color: #41007F; /* KLA Purple */
  font-weight: 700;
}}
h4, h5 {{
  color: #00A7E1; /* KLA Blue */
}}

/* Update chips */
.update-chip {{
  display:inline-flex; align-items:center; gap:.5rem;
  padding:.4rem .75rem;
  border-radius:999px;
  border:2px solid #41007F;
  margin:.25rem 0;
  cursor:pointer;
  font-size: 0.9rem;
  background: #FFFFFF;
  transition: all .15s ease-in-out;
}}
.update-chip:hover {{
  background: #00A7E1;
  color: #FFFFFF;
}}
.swatch {{
  width:.85rem; height:.85rem;
  border-radius:999px;
  border:1px solid rgba(0,0,0,.2);
}}

/* Panels */
.panel {{
  border:1px solid #E5E5E5;
  border-radius:12px;
  padding:1rem;
  background:#FFFFFF;
  box-shadow: 0px 2px 4px rgba(0,0,0,.08);
}}

/* Highlighted text */
.hl {{
  padding:0 .15rem;
  border-bottom-width:3px;
  border-bottom-style:solid;
  background: rgba(65,0,127,.05); /* Light purple tint */
}}

/* Code/standards pills */
.codepill {{
  display:inline-block;
  padding:.25rem .5rem;
  border-radius:6px;
  border:1px solid #41007F;
  background:#F8F5FC; /* very light purple */
  font-size:.8rem;
  margin:.2rem .3rem 0 0;
  color:#41007F;
  font-weight:600;
}}

/* Buttons */
.stButton > button {{
  background-color: #41007F;
  color: #FFFFFF;
  border:none;
  border-radius:8px;
  padding:.5rem 1rem;
  font-weight:600;
}}
.stButton > button:hover {{
  background-color:#00A7E1;
  color:#FFFFFF;
}}
</style>
"""

st.markdown(CUSTOM_CSS, unsafe_allow_html=True)

# -----------------------------------
# Robust matching helpers (fix for #3)
# -----------------------------------
import re
import unicodedata
from difflib import SequenceMatcher

PALETTE = [
    "#7F56D9", "#12B76A", "#F97066", "#2E90FA", "#F79009",
    "#9E77ED", "#32D583", "#F670C7", "#12A6AD", "#F04438"
]
def color_for(idx): 
    return PALETTE[idx % len(PALETTE)]

def _normalize(s: str) -> str:
    if s is None:
        return ""
    s = unicodedata.normalize("NFKC", s)
    # unify quotes/dashes/spaces
    s = s.replace("“", '"').replace("”", '"').replace("’", "'").replace("‘", "'").replace("–", "-").replace("—", "-")
    s = re.sub(r"\s+", " ", s.strip())
    return s

def _best_span(full_text: str, snippet: str):
    """Return (start, end) of the best matching span of `snippet` in `full_text`.
       Uses exact search on normalized text, then fuzzy if needed."""
    if not snippet:
        return None
    full_raw, snip_raw = full_text or "", snippet or ""
    full, snip = _normalize(full_raw), _normalize(snip_raw)

    # 1) exact
    i = full.find(snip)
    if i >= 0:
        return i, i + len(snip)

    # 2) fuzzy: search windowed around snip's first/last 6 words
    snip_words = snip.split()
    if not snip_words:
        return None
    anchors = []
    if len(snip_words) >= 3:
        anchors.append(" ".join(snip_words[:6]))
        anchors.append(" ".join(snip_words[-6:]))
    else:
        anchors.append(snip)

    best = (0.0, None)
    for anc in anchors:
        # sliding window over full text by characters around anchor occurrences
        for m in re.finditer(re.escape(anc), full):
            start = max(0, m.start() - 300)
            end   = min(len(full), m.end() + 300)
            window = full[start:end]
            sm = SequenceMatcher(None, window, snip)
            ratio = sm.ratio()
            if ratio > best[0]:
                # recover the matching block with highest contribution
                # (approximate: take the longest matching block)
                blocks = sm.get_matching_blocks()
                if blocks:
                    # expand block to approximate full snip length bounds inside window
                    block = max(blocks, key=lambda b: b.size)
                    guess_start = start + max(0, block.a - 50)
                    guess_end   = min(len(full), guess_start + len(snip) + 100)
                    best = (ratio, (guess_start, guess_end))
    if best[1]:
        return best[1]
    return None

def _html_highlight(full_text: str, snippet: str, color: str) -> str:
    """Return HTML with a highlighted span for snippet (robust), or a helpful fallback."""
    if not full_text:
        return "<div class='panel'><em>No text provided.</em></div>"
    span = _best_span(full_text, snippet)
    if not snippet:
        return f"<div class='panel'><div class='small'>No snippet to highlight.</div><div>{html.escape(full_text)}</div></div>"
    if not span:
        # Fallback: show target snippet panel
        return (
            "<div class='panel'>"
            "<legend>Target snippet (approximate, not found verbatim)</legend>"
            f"<span class='hl' style='border-color:{color}'>{html.escape(snippet)}</span>"
            "</div>"
        )
    s, e = span
    before = html.escape(full_text[:s])
    hit    = html.escape(full_text[s:e])
    after  = html.escape(full_text[e:])
    return f"<div class='panel'>{before}<span class='hl' style='border-color:{color}'>{hit}</span>{after}</div>"

def mini_diff(a: str, b: str) -> str:
    """Inline tiny diff: insertions +, deletions − (monospace)."""
    out = []
    for token in ndiff((a or "").split(), (b or "").split()):
        if token.startswith("+ "):
            out.append(f"<span style='background:rgba(18,183,106,.12);'>+{html.escape(token[2:])}</span>")
        elif token.startswith("- "):
            out.append(f"<span style='background:rgba(240,68,56,.12);'>-{html.escape(token[2:])}</span>")
        elif token.startswith("? "):
            continue
        else:
            out.append(html.escape(token[2:]))
    return "<div style='font-family:ui-monospace, SFMono-Regular, Menlo, monospace'>" + " ".join(out) + "</div>"

# Build ids index
id_to_idx = {u["id"]: i for i, u in enumerate(transformed_updates)}

# --------------------------
# Sidebar: filters + picker
# --------------------------
with st.sidebar:
    st.header("Updates")

    type_filter = st.multiselect(
        "Filter by change type",
        options=["addition", "modification", "removal"],
        default=["addition", "modification"],
        help="Show only certain update types."
    )
    search = st.text_input("Search updates (text or standard id)", "")

    # Apply filters
    filtered = []
    for i, upd in enumerate(transformed_updates):
        if upd["change_type"] not in type_filter:
            continue
        hay = " ".join([upd["raw_request"], " ".join(upd["standard_refs"])])
        if search.strip() and search.lower() not in hay.lower():
            continue
        filtered.append((i, upd))

    if not filtered:
        st.info("No updates match your filters.")
        st.stop()

    # Make a stable options list
    options = [
        f"{upd['id']} • {upd['raw_request']}" for _, upd in filtered
    ]

    # Maintain selection by position (fix for #4/#6)
    sel_pos = st.session_state.get("sel_pos", 0)
    if sel_pos >= len(filtered):
        sel_pos = 0

    # Radio for selection (fix for #1/#2)
    choice = st.radio(
        "Pick an update",
        options,
        index=sel_pos,
        key="update_choice",
        label_visibility="collapsed",
    )

    # Resolve selection and keep position in sync
    sel_pos = options.index(choice)
    st.session_state["sel_pos"] = sel_pos
    sel_idx_global, selected = filtered[sel_pos]
    sel_id = selected["id"]
    sel_color = color_for(sel_idx_global)

    # Standards legend (unchanged visual, but now stateful)
    st.markdown("---")
    st.caption("Standards referenced")
    for code in selected["standard_refs"]:
        st.markdown(
            f"<span class='codepill' style='border-color:{sel_color};'>{html.escape(code)}</span>",
            unsafe_allow_html=True
        )

# --------------
# Main layout UI
# --------------
st.title("Responsible Sourcing – Update Reviewer")

colA, colB = st.columns([1, 1])
with colA:
    st.subheader("Original (2023)")
    st.caption("Select an update on the left to see the precise passage.")
    st.markdown(
        _html_highlight(original_text_2023, selected.get("original_text_to_highlight", ""), sel_color),
        unsafe_allow_html=True
    )

with colB:
    st.subheader("Updated (2024)")
    st.caption("The passage reflecting the change (or proposed insertion).")

    # Handle "addition" items elegantly (fix for #5)
    is_addition = (selected.get("change_type") == "addition")
    new_snip = selected.get("new_text_to_highlight", "")

    if is_addition and not new_snip:
        # No concrete snippet—show insertion instruction
        st.markdown(
            f"<div class='panel'><b>Planned insertion</b><br>"
            f"<span class='small'>Target section:</span> {html.escape(selected.get('target_section_hint','(unspecified)'))}"
            f"</div>",
            unsafe_allow_html=True
        )
    else:
        # If addition but we DO have proposed text (e.g., u6), highlight it in context;
        # If not found in the updated text (because it's not inserted yet), show the proposal block.
        html_block = _html_highlight(outputted_text_2024, new_snip, sel_color)
        if "Target snippet (approximate, not found verbatim)" in html_block and is_addition:
            st.info("Proposed new text (not yet placed verbatim in the 2024 draft):")
            st.code(new_snip or "(no proposed text)", language="markdown")
        else:
            st.markdown(html_block, unsafe_allow_html=True)

# -----------------------
# Standards & mini diff
# -----------------------
st.markdown("### Standards & Details")
with st.expander("Show standards for the selected update", expanded=True):
    pills = "".join(
        f"<div class='codepill' style='border-color:{sel_color}; display:inline-block'>{html.escape(code)}</div>"
        for code in selected["standard_refs"]
    )
    details = "".join(
        f"<div class='small'><b>{html.escape(code)}</b>: {html.escape(standards_index.get(code, {}).get('clause',''))}</div>"
        for code in selected["standard_refs"]
    )
    st.markdown(f"<div class='panel'><legend>Linked Standards</legend>{pills}<div style='height:.5rem'></div>{details}</div>", unsafe_allow_html=True)

st.markdown("### Diff View (optional)")
show_diff = st.toggle("Show mini diff for this update")
if show_diff:
    old_snip = selected.get("original_text_to_highlight", "") or ""
    new_snip = selected.get("new_text_to_highlight", "") or ""
    if old_snip and new_snip:
        st.markdown(mini_diff(old_snip, new_snip), unsafe_allow_html=True)
    elif new_snip and not old_snip:
        st.info("Addition: no old snippet to diff.")
        st.markdown(mini_diff("", new_snip), unsafe_allow_html=True)
    elif old_snip and not new_snip:
        st.info("Removal: no new snippet to diff.")
        st.markdown(mini_diff(old_snip, ""), unsafe_allow_html=True)
    else:
        st.warning("No snippets available for diff.")

# -------------
# Export bundle
# -------------
st.markdown("### Export")
bundle = {
    "selected_update": selected,
    "original_text_2023": original_text_2023,
    "outputted_text_2024": outputted_text_2024
}
st.download_button(
    "Download selected update bundle (JSON)",
    data=json.dumps(bundle, ensure_ascii=False, indent=2),
    file_name=f"{sel_id}_bundle.json"
)

# -----------------
# Queue navigation
# -----------------
st.markdown("---")
col_prev, col_next = st.columns([1,1])
with col_prev:
    if st.button("◀ Previous", use_container_width=True):
        st.session_state["sel_pos"] = max(0, st.session_state.get("sel_pos", 0) - 1)
        st.rerun()
with col_next:
    if st.button("Next ▶", use_container_width=True):
        st.session_state["sel_pos"] = min(len(filtered)-1, st.session_state.get("sel_pos", 0) + 1)
        st.rerun()